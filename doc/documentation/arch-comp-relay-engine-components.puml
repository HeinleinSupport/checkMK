@startuml
skinparam componentStyle rectangle

package "Relay Engine" {
    package "Core" {
        queue "Main Queue" as queue
        component "Main Loop" as loop
        loop -down- queue
    }

    package "Schedulers" {
        component "Service\nScheduler" as service_sched
        component "Poll\nScheduler" as poll_sched
        component "Cert Rotation\nScheduler" as cert_sched
    }

    package "Processors" {
        component "Fetcher\nPool" as pool
        component "Ad-hoc\nFetcher Pool" as adhoc_pool
        component "Site\nProcessor" as site
        component "Config\nProcessor" as config
        component "Cert Rotation\nProcessor" as cert_proc
    }

    package "Fetcher Subprocesses" {
        component "Fetcher 1" as f1
        component "Fetcher 2" as f2
        component "..." as f3
        component "Ad-hoc\nFetcher 1" as af1
    }
}

' Schedulers generate tasks
service_sched -down-> queue : FetchTask
poll_sched -down-> queue : AdHocFetchTask,\nConfigUpdateTask
cert_sched -down-> queue : CertRotationTask

' Main loop routes to processors
loop -down-> pool : FetchTask
loop -down-> adhoc_pool : AdHocFetchTask
loop -down-> site : FetchResult,\nAdHocFetchResult
loop -down-> config : ConfigUpdateTask
loop -down-> cert_proc : CertRotationTask

' Processors submit results
pool -up-> queue : FetchResult,\nFetchError
adhoc_pool -up-> queue : AdHocFetchResult,\nAdHocFetchError
config -up-> queue : ApplyConfigTask,\nConfigUpdateResult
service_sched -up-> queue : (receives\nFetchResult)

' Fetcher pools manage subprocesses
pool -down-> f1 : Tasks via stdin
pool -down-> f2 : Tasks via stdin
pool -down-> f3
adhoc_pool -down-> af1 : Tasks via stdin

f1 -up-> pool : Results via stdout
f2 -up-> pool : Results via stdout
af1 -up-> adhoc_pool : Results via stdout

' External communication
site -right-> [Agent Receiver] : HTTPS +\nmTLS

note right of queue
  All communication
  through queue creates
  complete audit trail
end note

note bottom of loop
  Main loop = simple router
  No business logic
  Pattern matching on task type
end note

note left of service_sched
  Maintains schedule for
  all configured services
  Generates tasks when due
end note

note right of pool
  Manages pool of
  fetcher subprocesses
  Distributes tasks
end note

@enduml
